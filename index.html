<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB POKER - èŒä¸šèµ›åœº</title>
    <style>
        :root { 
            --bg-dark: #242b35; --table-inner: #248ceb; --panel-bg: #11151a; 
            --gold: #ffd700; --active-green: #2ecc71; 
        }
        body { margin: 0; padding: 0; background-color: var(--bg-dark); color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center;}
        .view-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        .menu-card { background: var(--panel-bg); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 1px solid #333; width: 320px; position: relative;}
        .logo-title { color: var(--gold); font-size: 32px; font-weight: 900; letter-spacing: 2px; margin-bottom: 30px; margin-top: 0;}
        .btn-main { width: 100%; padding: 16px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 15px; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: black; } .btn-gold:hover { transform: scale(1.03); background: #e6c200; }
        .btn-dark { background: #2a3441; color: white; border: 1px solid #444; } .btn-dark:hover { background: #354252; }
        .input-group { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
        .input-code { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; text-align: center; font-size: 16px; font-weight: bold; letter-spacing: 2px; outline: none; text-transform: uppercase;}
        .input-code:focus { border-color: var(--gold); }
        .btn-join { padding: 0 25px; border-radius: 8px; border: none; background: #1976d2; color: white; font-weight: bold; cursor: pointer; transition: 0.2s;}

        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; color: #aaa; font-size: 14px; font-weight: bold; cursor: pointer; }
        .settings-header span:hover { color: var(--gold); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; text-align: left;}
        .setting-label { font-size: 14px; color: #ccc; flex: 1; }
        .setting-input { width: 100px; padding: 8px 12px; border-radius: 6px; background: #1a2028; border: 1px solid #444; color: white; font-size: 14px; font-weight: bold; outline: none; text-align: right; transition: border-color 0.2s; }

        #table-container { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .poker-table { width: 80vw; height: 50vh; max-width: 1000px; max-height: 550px; background: radial-gradient(circle, #349feb 0%, var(--table-inner) 100%); border: 20px solid #1c232c; border-radius: 250px; box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 40px rgba(0,0,0,0.3); position: relative; }
        
        .pot-display-container { position: absolute; top: 25%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 215, 0, 0.3); padding: 8px 25px; border-radius: 30px; text-align: center; z-index: 5;}
        .pot-label { font-size: 11px; color: #aaa; display: block; }
        .pot-value { font-size: 22px; font-weight: 900; color: var(--gold); }
        .top-left-logo { position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: 900; letter-spacing: 2px; }
        .community-cards-area { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; z-index: 5; gap: 8px;}

        .burn-area { display: flex; position: relative; margin-right: 25px; border-right: 2px dashed rgba(255,255,255,0.3); padding-right: 15px; align-items: center; height: 60px; width: 50px;}
        .burn-area .playing-card { position: absolute; left: 0; box-shadow: -2px 2px 5px rgba(0,0,0,0.8); }

        .invite-pill { background: rgba(17, 21, 26, 0.95); padding: 20px 40px; border-radius: 50px; text-align: center; border: 1px solid #333; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.5); transition: 0.2s; }
        .invite-pill:hover { background: #1a2028; transform: scale(1.02); }

        .winner-banner { position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.9); border: 2px solid var(--gold); color: white; padding: 25px 40px; border-radius: 15px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.9); z-index: 200; white-space: nowrap; animation: popIn 0.5s ease;}
        @keyframes popIn { 0% { transform: translate(-50%, -40%) scale(0.8); opacity: 0;} 100% { transform: translate(-50%, -50%) scale(1); opacity: 1;} }
        .win-fly-text { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); color: #2ecc71; font-size: 28px; font-weight: 900; text-shadow: 0 4px 10px rgba(0,0,0,1); animation: floatUp 4s ease-out forwards; z-index: 50; pointer-events: none; white-space: nowrap; }
        @keyframes floatUp { 0% { top: 20px; opacity: 0; transform: translateX(-50%) scale(0.5); } 10% { top: -20px; opacity: 1; transform: translateX(-50%) scale(1.3); } 20% { top: -30px; opacity: 1; transform: translateX(-50%) scale(1); } 80% { top: -60px; opacity: 1; transform: translateX(-50%) scale(1); } 100% { top: -80px; opacity: 0; transform: translateX(-50%) scale(1); } }

        .playing-card { background: white; color: black; width: 42px; height: 60px; border-radius: 5px; font-weight: bold; font-size: 18px; display: flex; justify-content: center; align-items: center; box-shadow: -1px 2px 5px rgba(0,0,0,0.4); border: 1px solid #ccc; position: relative;}
        .playing-card.red { color: #d32f2f; }
        .playing-card.back { background: #1976d2; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,.1) 5px, rgba(255,255,255,.1) 10px); color: transparent;}
        
        /* ã€å‘ç‰Œæ—¶é—´è½´åŠ¨ç”»ã€‘ */
        @keyframes dealHoleCard { 0% { transform: translate(calc(50vw - 100%), calc(-50vh + 100%)) scale(0) rotate(180deg); opacity: 0; } 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; } }
        @keyframes dealBoardCard { 0% { transform: translate(0, -100px) scale(0) rotate(180deg); opacity: 0; } 100% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; } }

        .player-seat { position: absolute; display: flex; flex-direction: column; align-items: center; transform: translate(-50%, -50%); transition: all 0.3s ease;}
        
        /* ã€æ ¸å¿ƒæ”¹åŠ¨ï¼šå¡ç‰‡åŠ å®½åˆ° 110pxï¼Œå†…éƒ¨å…ƒç´ æ¨¡å—åŒ–ã€‘ */
        .player-card { width: 110px; min-height: 85px; background: #000; border-radius: 8px; overflow: visible; border: 2px solid transparent; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; position: relative; display: flex; flex-direction: column; justify-content: space-between;}
        .player-card.active { border-color: var(--active-green); box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);}
        .player-card.active .player-chips { background: var(--active-green); color: #000; }
        .player-card.empty-seat { background: rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.05); box-shadow: none; min-height: 85px; border-radius: 8px; }
        
        /* ã€æ ¸å¿ƒæ”¹åŠ¨ï¼šè¸¢äººå±…ä¸­ä¸Šæ–¹æ‚¬æµ®ã€‘ */
        .kick-btn { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; border: 1px solid #111; border-radius: 5px; font-size: 12px; padding: 4px 12px; cursor: pointer; z-index: 30; box-shadow: 0 4px 10px rgba(0,0,0,0.8); display: none; font-weight: bold; white-space: nowrap;}
        .kick-btn:hover { background: #ff5b4c; transform: translateX(-50%) scale(1.05);}
        .player-seat:hover .kick-btn { display: block; }

        .player-avatar { padding-top: 8px; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2;}
        .player-avatar span { font-size: 26px; line-height: 1; }
        .player-name { font-size: 11px; color: #ddd; margin-top: auto; padding-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; z-index: 2;}
        .player-chips { background: #4b5d6d; text-align: center; font-size: 13px; font-weight: bold; padding: 5px 0; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; z-index: 2;}
        
        /* ã€æ ¸å¿ƒæ”¹åŠ¨ï¼šå†…åµŒå¼ç²¾è‡´çŠ¶æ€æ ‡ç­¾ï¼Œä¸å†é®æŒ¡å¡ç‰‡ã€‘ */
        .status-badge-inner { font-size: 11px; font-weight: bold; padding: 2px 8px; border-radius: 4px; margin: 4px auto; width: fit-content; text-align: center; z-index: 2; letter-spacing: 1px; }
        .bg-offline { background: rgba(100,100,100,0.8); color: white; }
        .bg-fold { background: rgba(217, 83, 121, 0.9); color: white; }
        .bg-think { background: rgba(46, 204, 113, 0.9); color: black; }
        .bg-allin { background: rgba(255, 215, 0, 0.9); color: black; }

        .out-state { filter: grayscale(1) brightness(0.4); opacity: 0.8; }
        .eliminated-x { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 50px; color: #ff3b3b; z-index: 20; pointer-events: none; font-weight: 900; text-shadow: 0 4px 10px rgba(0,0,0,1); }

        .hole-cards { position: absolute; display: flex; z-index: 5; }
        .card-1 { margin-right: -10px; z-index: 1; } .card-2 { z-index: 2; }
        
        /* ã€æ ¸å¿ƒæ”¹åŠ¨ï¼šç­¹ç æ–¹ä½ç»å¯¹éš”ç¦»é¿è®©ã€‘ */
        .bet-badge { position: absolute; background: rgba(0,0,0,0.85); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; border: 1px solid #777; z-index: 15; white-space: nowrap; color: var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        
        /* ä¸Šä¸‹æ–¹ï¼šæ‰‹ç‰Œæ”¾åœ¨å¡ç‰‡åï¼Œç­¹ç ä¾§ç½® */
        .pos-bottom .hole-cards { top: -45px; left: 50%; transform: translateX(-50%); } 
        .pos-bottom .bet-badge { top: -35px; right: -40px; } /* ç­¹ç æ”¾å³ä¾§ */
        
        .pos-top .hole-cards { bottom: -45px; left: 50%; transform: translateX(-50%); }
        .pos-top .bet-badge { bottom: -35px; right: -40px; }

        /* å·¦å³æ–¹ï¼šæ‰‹ç‰Œå±…ä¸­ï¼Œç­¹ç å¾€æ¡Œå¿ƒæ¨ */
        .pos-left .hole-cards { top: -45px; left: 50%; transform: translateX(-50%); }
        .pos-left .bet-badge { top: 50%; left: 100%; margin-left: 15px; transform: translateY(-50%); } /* æ”¾å³ä¾§ */
        
        .pos-right .hole-cards { top: -45px; left: 50%; transform: translateX(-50%); }
        .pos-right .bet-badge { top: 50%; right: 100%; margin-right: 15px; transform: translateY(-50%); } /* æ”¾å·¦ä¾§ */

        .s-btm-c { top: 102%; left: 50%; } .s-lft-b { top: 75%; left: 6%; } .s-lft-t { top: 25%; left: 6%; } .s-top-l { top: -2%; left: 22%; } .s-top-c { top: -2%; left: 50%; }
        .s-top-r { top: -2%; left: 78%; } .s-rgt-t { top: 25%; left: 94%; } .s-rgt-b { top: 75%; left: 94%; } .s-btm-r { top: 102%; left: 78%; } .s-btm-l { top: 102%; left: 22%; }

        .avatar-opt { font-size: 30px; padding: 5px; cursor: pointer; border-radius: 10px; border: 2px solid transparent; transition: 0.2s; user-select: none; }
        .avatar-opt:hover { transform: scale(1.1); }
        .avatar-opt.selected { border-color: var(--gold); background: rgba(255,215,0,0.2); }

        .host-panel { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; font-size: 12px; color: #aaa; z-index: 20; width: 160px; box-sizing: border-box;}
        .host-btn { width: 100%; padding: 10px; margin-top: 8px; border-radius: 6px; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        .btn-green { background: var(--active-green); color: black; }
        .btn-red { background: #e74c3c; color: white; margin-top: 5px;}
        .host-btn:hover { filter: brightness(1.1); }

        #btn-take-seat { position:absolute; bottom:120px; left:50%; transform:translateX(-50%); padding: 15px 40px; border-radius: 50px; background:var(--gold); color:black; font-weight:bold; font-size:18px; border:none; cursor:pointer; z-index:30; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: 0.2s;}
        #btn-take-seat:hover { transform: translateX(-50%) scale(1.05); }

        .action-console { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(17, 21, 26, 0.95); border: 1px solid #333; border-radius: 16px; padding: 20px; width: 480px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .turn-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: black; font-weight: 900; font-size: 13px; padding: 4px 15px; border-radius: 20px; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
        .raise-control-area { display: flex; flex-direction: column; gap: 12px; background: #1a2028; padding: 15px; border-radius: 12px; border: 1px solid #2a3441; }
        .raise-header { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #8ca0b3; font-weight: bold; }
        .raise-amount-display { font-size: 24px; color: var(--gold); font-weight: 900; letter-spacing: 1px; }
        .custom-slider { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: #333; outline: none; margin: 10px 0; }
        .custom-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; border-radius: 50%; background: var(--gold); cursor: pointer; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); border: 3px solid #11151a; }
        .quick-bet-row { display: flex; justify-content: space-between; gap: 8px; }
        .qb-btn { flex: 1; background: #2a3441; color: #ddd; border: none; padding: 8px 0; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .qb-btn:hover { background: #354252; color: white; }
        .qb-btn.all-in { background: rgba(217, 83, 121, 0.2); color: #d95379; border: 1px solid #d95379; }
        .qb-btn.all-in:hover { background: #d95379; color: white; }
        .main-action-row { display: flex; gap: 10px; height: 65px; }
        .action-btn { flex: 1; border: none; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.1s; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .action-btn:active { transform: scale(0.96); }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; box-shadow: none; filter: grayscale(1); }
        .btn-title { font-size: 18px; font-weight: 900; letter-spacing: 1px; color: white; }
        .btn-sub { font-size: 13px; font-weight: bold; opacity: 0.9; margin-top: 2px; }
        .btn-fold { background: linear-gradient(145deg, #d95379, #b03a5b); }
        .btn-call { background: linear-gradient(145deg, #1976d2, #115293); }
        .btn-raise { background: linear-gradient(145deg, #ffd700, #d4b400); }
        .btn-raise .btn-title, .btn-raise .btn-sub { color: #11151a; }
    </style>
</head>
<body>

    <div id="view-home" class="view-screen">
        <div class="menu-card">
            <h1 class="logo-title">POKERCHILL</h1>
            <button class="btn-main btn-gold" onclick="navTo('view-settings')">New Game</button>
            <div class="input-group">
                <input type="text" id="join-code" class="input-code" placeholder="è¾“å…¥ 5 ä½æˆ¿å·">
                <button class="btn-join" onclick="joinByCode()">Enter</button>
            </div>
        </div>
    </div>

    <div id="view-settings" class="view-screen hidden">
        <div class="menu-card" style="width: 380px;">
            <div class="settings-header"><span onclick="navTo('view-home')">âŸµ Back</span><span style="color:var(--gold);" onclick="createRoomFlow()">Continue âŸ¶</span></div>
            <h2 style="margin-top:0; color:white; letter-spacing: 1px;">CASH GAME</h2>
            <div class="setting-item"><span class="setting-label">ä¹°å…¥é‡‘é¢ (Buy-in)</span><input type="number" id="set-buyin" class="setting-input" value="10000"></div>
            <div class="setting-item"><span class="setting-label">å°ç›²æ³¨ (Small Blind)</span><input type="number" id="set-sb" class="setting-input" value="50" step="any"></div>
        </div>
    </div>

    <div id="sit-modal" class="view-screen hidden" style="background: rgba(0,0,0,0.85); z-index: 200;">
        <div class="menu-card" style="width: 320px;">
            <h2 style="color:var(--gold); margin-top:0; margin-bottom: 20px;">Take a Seat</h2>
            <div style="text-align: left; font-size: 13px; color:#aaa; margin-bottom: 8px;">1. é€‰æ‹©å¤´åƒ</div>
            <div id="avatar-grid" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom: 25px; background: #1a2028; padding: 15px; border-radius: 12px; border: 1px solid #333;"></div>
            <div style="text-align: left; font-size: 13px; color:#aaa; margin-bottom: 8px;">2. è¾“å…¥æ‚¨çš„å°Šå§“å¤§å</div>
            <input type="text" id="sit-name" class="input-code" placeholder="Your Nickname" style="width:100%; box-sizing:border-box; margin-bottom: 25px;">
            <button id="btn-confirm-sit" class="btn-main btn-gold" onclick="confirmSit()">ç¡®å®šå…¥åº§</button>
            <button class="btn-main btn-dark" style="margin-bottom:0;" onclick="document.getElementById('sit-modal').classList.add('hidden')">å–æ¶ˆæ—è§‚</button>
        </div>
    </div>

    <div id="view-game" class="view-screen hidden">
        <div class="top-left-logo" style="color:var(--gold)">POKERCHILL</div>
        <div id="table-container">
            <div class="poker-table">
                <div class="pot-display-container"><span class="pot-label">TOTAL POT</span><span class="pot-value" id="ui-pot">$0</span></div>
                <div class="community-cards-area" id="ui-board"></div>
                <div id="invite-pill-container" style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; display: flex; flex-direction: column; align-items: center;">
                    <div class="invite-pill" onclick="copyInviteLink()">
                        <div style="color: white; font-weight: bold; font-size: 15px; margin-bottom: 5px; opacity: 0.9;">åˆ†äº«ç»™æœ‹å‹ (ç‚¹å‡»å¤åˆ¶é“¾æ¥):</div>
                        <div id="display-room-url" style="color: #8ca0b3; font-size: 16px; letter-spacing: 2px; font-weight: bold;">ROOM: ------</div>
                    </div>
                </div>
                <div id="winner-banner" class="winner-banner hidden"></div>
                <div id="players-layer"></div>
            </div>
        </div>

        <button id="btn-take-seat" class="hidden" onclick="openSitModal()">ğŸª‘ å…¥åº§å‚ä¸ (Take a Seat)</button>

        <div class="host-panel hidden" id="host-panel">
            <div style="margin-bottom: 5px; opacity: 0.8; font-weight:bold; color:var(--gold);">ğŸ‘‘ æˆ¿ä¸»æ§åˆ¶å°</div>
            <div style="margin-bottom: 10px; opacity: 0.6;">$<span id="info-buyin">0</span> | ç›²æ³¨ <span id="info-blinds">0/0</span></div>
            <button onclick="triggerStartGame()" id="btn-start" class="host-btn btn-green">â–¶ å¼€å§‹æ–°ä¸€å±€</button>
            <button onclick="forceRestart()" id="btn-force-restart" class="host-btn btn-red">ğŸ›‘ å¼ºåˆ¶é‡å¼€å±€</button>
        </div>

        <div id="waiting-tip" class="waiting-tip hidden" style="bottom: 30px;">ç­‰å¾…å¯¹æ‰‹è¡ŒåŠ¨...</div>

        <div id="rebuy-console" class="action-console hidden" style="justify-content: center; align-items: center; padding: 30px;">
            <h3 style="margin-top:0; color:#ff3b3b; font-size: 24px;">ç­¹ç è€—å°½ï¼Œæ‚¨å·²å‡ºå±€</h3>
            <button onclick="triggerRebuy()" style="width:100%; padding: 15px; background: var(--gold); font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer; border: none; color: black;">ğŸ’° è¡¥å……ç­¹ç é‡æ–°å…¥å±€</button>
        </div>

        <div id="action-console" class="action-console hidden">
            <div class="turn-badge">YOUR TURN</div>
            <div class="raise-control-area">
                <div class="raise-header">
                    <span>Raise To (åŠ æ³¨è‡³):</span>
                    <span class="raise-amount-display" id="display-amount">$0</span>
                </div>
                <input type="range" class="custom-slider" id="raise-slider" oninput="updateSliderDisplay()">
                <div class="quick-bet-row">
                    <button class="qb-btn" onclick="quickBet('MIN')">MIN</button>
                    <button class="qb-btn" onclick="quickBet('HALF')">1/2 POT</button>
                    <button class="qb-btn" onclick="quickBet('POT')">POT</button>
                    <button class="qb-btn all-in" onclick="quickBet('ALLIN')">ALL-IN</button>
                </div>
            </div>
            <div class="main-action-row">
                <button class="action-btn btn-fold" id="btn-action-fold"><span class="btn-title">FOLD</span><span class="btn-sub">å¼ƒç‰Œ</span></button>
                <button class="action-btn btn-call" id="btn-action-call"><span class="btn-title" id="btn-call-title">CALL</span><span class="btn-sub" id="btn-call-sub">$0</span></button>
                <button class="action-btn btn-raise" id="btn-action-raise"><span class="btn-title">RAISE</span><span class="btn-sub" id="btn-raise-sub">$0</span></button>
            </div>
        </div>
    </div>

<script>
    const BACKEND_URL = "https://poker-server.zxc717209554.workers.dev";
    const SEAT_ORDER = ['s-btm-c', 's-lft-b', 's-lft-t', 's-top-l', 's-top-c', 's-top-r', 's-rgt-t', 's-rgt-b', 's-btm-r', 's-btm-l'];
    const AVATAR_LIST = ['ğŸ˜', 'ğŸ¤–', 'ğŸ¤¡', 'ğŸ¤ ', 'ğŸ‘½', 'ğŸ‘»', 'ğŸ¼', 'ğŸ§›', 'ğŸ»', 'ğŸ¦Š', 'ğŸ¯', 'ğŸ·'];
    const MAX_SEATS = 10;

    let ws = null;
    let myName = ""; 
    let currentRoomId = null;
    let selectedAvatar = 'ğŸ˜';
    let isWaitingForServer = false;
    let latestGameState = null;
    let countdownInterval = null; 
    let wasISeated = false; // ç”¨äºåˆ¤å®šæ˜¯å¦è¢«è¸¢

    // ã€æ–°å¢ï¼šå‘ç‰Œæ—¶é—´è½´é”ï¼Œé˜²æ­¢æ¯æ¬¡é‡ç»˜éƒ½å‘ç‰Œã€‘
    let prevBoardLength = 0;
    let prevBurnLength = 0;

    const slider = document.getElementById('raise-slider');
    const displayAmount = document.getElementById('display-amount');
    const btnRaiseSub = document.getElementById('btn-raise-sub');

    function updateSliderDisplay() {
        displayAmount.innerText = "$" + slider.value;
        btnRaiseSub.innerText = "$" + slider.value;
        if(parseInt(slider.value) >= parseInt(slider.max)) { displayAmount.innerText = "ALL-IN"; btnRaiseSub.innerText = "ALL-IN"; }
    }

    function quickBet(type) {
        if(!latestGameState || !latestGameState.game) return;
        const currentBet = latestGameState.game.currentBet || 0;
        const pot = latestGameState.game.pot || 0;
        const minRaiseTo = parseInt(slider.min) || 0;
        let target = minRaiseTo;
        if (type === 'MIN') target = minRaiseTo;
        if (type === 'HALF') target = currentBet + (pot / 2);
        if (type === 'POT') target = currentBet + pot;
        if (type === 'ALLIN') target = parseInt(slider.max);
        target = Math.floor(target);
        if (target < minRaiseTo) target = minRaiseTo;
        if (target > parseInt(slider.max)) target = parseInt(slider.max);
        slider.value = target; updateSliderDisplay();
    }

    function checkAutoLogin() {
        if (!currentRoomId) return false;
        const saved = localStorage.getItem('poker_session_' + currentRoomId);
        if (saved) {
            const data = JSON.parse(saved); myName = data.name; selectedAvatar = data.avatar || 'ğŸ˜';
            isWaitingForServer = true; connectWebSocket(); return true;
        }
        return false;
    }

    window.onload = () => { 
        const roomCode = new URLSearchParams(window.location.search).get('room'); 
        if (roomCode) {
            currentRoomId = roomCode.toUpperCase(); document.getElementById('join-code').value = currentRoomId; 
            document.getElementById('display-room-url').innerText = `ROOM CODE: ${currentRoomId}`; navTo('view-game');
            if (!checkAutoLogin()) openSitModal();
        }
    };
    
    function navTo(targetViewId) { document.querySelectorAll('.view-screen').forEach(el => el.classList.add('hidden')); document.getElementById(targetViewId).classList.remove('hidden'); }
    function copyInviteLink() { navigator.clipboard.writeText(window.location.href).then(() => { const el = document.getElementById('display-room-url'); const originalText = el.innerText; el.innerText = "âœ“ é“¾æ¥å·²å¤åˆ¶!"; el.style.color = "var(--active-green)"; setTimeout(() => { el.innerText = originalText; el.style.color = "#8ca0b3"; }, 2000); }); }
    function openSitModal() { document.getElementById('sit-modal').classList.remove('hidden'); renderAvatarGrid(); }
    function renderAvatarGrid() { document.getElementById('avatar-grid').innerHTML = AVATAR_LIST.map(a => `<div class="avatar-opt ${a===selectedAvatar?'selected':''}" onclick="selectAvatar('${a}')">${a}</div>`).join(""); }
    function selectAvatar(a) { selectedAvatar = a; renderAvatarGrid(); }

    function confirmSit() {
        const nameInput = document.getElementById('sit-name').value.trim();
        if(!nameInput) return alert("è¯·è¾“å…¥æ˜µç§°ï¼(æ³¨æ„ï¼šä¸è¦å’Œåˆ«äººé‡å)");
        myName = selectedAvatar + "|" + nameInput; isWaitingForServer = true; 
        localStorage.setItem('poker_session_' + currentRoomId, JSON.stringify({ name: myName, avatar: selectedAvatar }));
        const btn = document.getElementById('btn-confirm-sit'); btn.innerText = "æ­£åœ¨å…¥åº§..."; btn.disabled = true;
        if (ws && ws.readyState === 1) { ws.send(JSON.stringify({ type: "JOIN", name: myName })); } 
        else { connectWebSocket(); setTimeout(() => { if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: "JOIN", name: myName })); }, 1000); }
        setTimeout(() => { if (isWaitingForServer) { alert("äº‘ç«¯æ— å“åº”ã€‚è¯·æ¢ä¸ªåå­—é‡è¯•ï¼"); btn.innerText = "ç¡®å®šå…¥åº§"; btn.disabled = false; isWaitingForServer = false; } }, 5000);
    }

    async function createRoomFlow() {
        try {
            const res = await fetch(`${BACKEND_URL}/create-room`, { method: "POST" });
            const data = await res.json(); currentRoomId = data.roomId; 
            window.history.pushState({}, "", `?room=${currentRoomId}`);
            document.getElementById('display-room-url').innerText = `ROOM CODE: ${currentRoomId}`;
            const buyInVal = parseFloat(document.getElementById('set-buyin').value) || 10000;
            const sb = parseFloat(document.getElementById('set-sb').value) || 50;
            document.getElementById('info-buyin').innerText = buyInVal; document.getElementById('info-blinds').innerText = `${sb}/${sb * 2}`;
            connectWebSocket(); navTo('view-game'); document.getElementById('host-panel').classList.remove('hidden');
            openSitModal(); renderEngine({ status: "WAITING", game: { pot: 0, status: "WAITING", board: [] }, players: [] });
        } catch (e) { alert("æ— æ³•è¿æ¥ Cloudflare æœåŠ¡å™¨ã€‚"); }
    }

    function triggerStartGame() {
        const buyInVal = parseFloat(document.getElementById('info-buyin').innerText) || 10000;
        const sb = parseFloat(document.getElementById('info-blinds').innerText.split('/')[0]) || 50;
        send({ type: 'START_GAME', settings: { initialChips: buyInVal, smallBlind: sb, bigBlind: sb * 2 } });
    }

    function forceRestart() { if(confirm("ç¡®å®šè¦å¼ºåˆ¶ç»“æŸå½“å‰å¯¹å±€å—ï¼Ÿæ¡Œé¢çš„æ‰€æœ‰ç‰Œå’Œåº•æ± å°†ä¼šè¢«æ¸…ç©ºï¼")) send({ type: 'FORCE_RESTART', name: myName }); }
    function triggerRebuy() { const buyInVal = parseFloat(document.getElementById('info-buyin').innerText) || 10000; send({ type: 'REBUY', name: myName, amount: buyInVal }); }

    function joinByCode() {
        currentRoomId = document.getElementById('join-code').value.trim().toUpperCase();
        if (!currentRoomId) return alert("è¯·è¾“å…¥ 5 ä½æˆ¿é—´ç ");
        window.history.pushState({}, "", `?room=${currentRoomId}`);
        document.getElementById('display-room-url').innerText = `ROOM CODE: ${currentRoomId}`;
        document.getElementById('host-panel').classList.add('hidden'); navTo('view-game'); 
        if (!checkAutoLogin()) { openSitModal(); renderEngine({ status: "WAITING", game: { pot: 0, status: "WAITING", board: [] }, players: [] }); }
    }

    function connectWebSocket() {
        const wsUrl = BACKEND_URL.replace("https://", "wss://") + `?roomId=${currentRoomId}`;
        ws = new WebSocket(wsUrl); ws.onopen = () => ws.send(JSON.stringify({ type: "PING" }));
        ws.onmessage = (e) => { try { latestGameState = JSON.parse(e.data); renderEngine(latestGameState); } catch (err) {} };
    }

    function send(obj) { if(ws && ws.readyState === 1) ws.send(JSON.stringify(obj)); else console.log("ç­‰å¾…é‡è¿..."); }

    function getSeatMap(roomId) {
        let seed = 0; if (roomId) for(let i=0; i<roomId.length; i++) seed += roomId.charCodeAt(i);
        if (seed === 0) seed = 123; let seats = [0,1,2,3,4,5,6,7,8,9];
        for(let i=0; i<10; i++) { let j = (seed + i * 17) % 10; if (isNaN(j) || j < 0) j = 0; let temp = seats[i]; seats[i] = seats[j]; seats[j] = temp; }
        return seats;
    }

    function renderEngine(state) {
        if (!state || !state.game) return;

        document.getElementById("ui-pot").innerText = "$" + (state.game.pot || 0);
        
        // ã€æ ¸å¿ƒåŠ¨ç”»ç®¡ç†ã€‘é‡ç½®æ—¶æ¸…ç©ºè½¨é“é”
        if (state.game.status === "WAITING" || state.game.status === "PRE-FLOP") {
            prevBoardLength = 0; prevBurnLength = 0;
        }

        // æ¸²æŸ“çƒ§ç‰Œä¸å‘ç‰Œç‰¹æ•ˆ (ç²¾å‡† Timeline)
        let burnCardsHtml = "";
        if (state.game.burnCards && state.game.burnCards.length > 0) {
            burnCardsHtml = `<div class="burn-area">` + 
                state.game.burnCards.map((c, i) => {
                    const animDelay = (i >= prevBurnLength) ? `animation: dealBoardCard 0.3s ease-out backwards;` : ``;
                    return `<div class="playing-card back" style="transform: rotate(${i*8 - 8}deg); left: ${i*15}px; position: ${i===0?'relative':'absolute'}; z-index: ${i}; ${animDelay}"></div>`
                }).join("") + `</div>`;
        }

        const boardCardsHtml = (state.game.board || []).map((c, i) => {
            let animDelay = "";
            if (i >= prevBoardLength) {
                // FLOP æ˜¯ä¸‰å¼ è¿å‘ï¼Œè¦æœ‰é˜¶æ¢¯æ„Ÿ (0.3s, 0.6s, 0.9s)ã€‚TURNå’ŒRIVERæ˜¯å•å‘ï¼Œç›´æ¥0.3sèµ·æ­¥ã€‚
                let delay = 0.3;
                if (state.game.status === "FLOP" && i >= prevBoardLength) delay = 0.3 + (i - prevBoardLength) * 0.3;
                animDelay = `animation: dealBoardCard 0.4s ease-out backwards; animation-delay: ${delay}s;`;
            }
            return `<div class="playing-card ${c.includes('â™¥') || c.includes('â™¦') ? 'red' : ''}" style="${animDelay}">${c}</div>`;
        }).join("");
        
        document.getElementById("ui-board").innerHTML = burnCardsHtml + boardCardsHtml;
        
        // æ¸²æŸ“å®Œæ¯•åè®°å½•é”ï¼Œé˜²æ­¢æ¯æ¬¡ç‚¹å‡»æ“ä½œéƒ½é‡æ’­åŠ¨ç”»
        prevBoardLength = state.game.board ? state.game.board.length : 0;
        prevBurnLength = state.game.burnCards ? state.game.burnCards.length : 0;

        const banner = document.getElementById("winner-banner");
        if (state.game.status === "SHOWDOWN") {
            if (!countdownInterval) {
                let timeLeft = 10;
                countdownInterval = setInterval(() => {
                    timeLeft--; const cdSpan = document.getElementById("auto-start-cd"); if (cdSpan) cdSpan.innerText = timeLeft;
                    if (timeLeft <= 0) { clearInterval(countdownInterval); countdownInterval = null; send({type: 'NEXT_HAND'}); }
                }, 1000);
            }
            banner.innerHTML = `
                <div style="margin-bottom: 15px; font-size: 22px;">${state.game.winMessage}</div>
                <div style="font-size: 15px; color: #ccc; display: flex; align-items: center; justify-content: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 12px; border-radius: 10px;">
                    <span>ä¸‹ä¸€å±€å€’æ•°: <span id="auto-start-cd" style="color:var(--gold); font-size:24px; font-weight:900;">10</span> ç§’</span>
                    <button onclick="send({type:'NEXT_HAND'})" style="padding: 8px 25px; background: var(--active-green); color: black; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px;">ç«‹åˆ»å¼€å§‹</button>
                </div>
            `;
            banner.classList.remove("hidden");
        } else {
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            banner.classList.add("hidden");
        }

        const isHost = (state.game.hostName === myName);
        if (isHost) {
            document.getElementById('host-panel').classList.remove('hidden');
            if (state.game.status !== "WAITING" && state.game.status !== "SHOWDOWN") { document.getElementById('btn-start').classList.add('hidden'); document.getElementById('btn-force-restart').classList.remove('hidden'); } 
            else { document.getElementById('btn-start').classList.remove('hidden'); document.getElementById('btn-force-restart').classList.add('hidden'); }
        } else { document.getElementById('host-panel').classList.add('hidden'); }

        const pill = document.getElementById("invite-pill-container");
        if(state.game.status !== "WAITING") pill.classList.add("hidden"); else pill.classList.remove("hidden");

        let playersArray = state.players || [];
        const pureMyName = myName.split('|')[1] || myName;
        let amISeated = playersArray.some(p => p && (p.name.split('|')[1] || p.name) === pureMyName);
        
        // ã€æ ¸å¿ƒï¼šå¼ºåˆ¶è¸¢å›é¦–é¡µåˆ¤æ–­ã€‘
        if (wasISeated && !amISeated && myName !== "" && !isWaitingForServer) {
            alert("æ‚¨å·²è¢«æˆ¿ä¸»ç§»å‡ºæˆ¿é—´ã€‚");
            myName = ""; localStorage.removeItem('poker_session_' + currentRoomId);
            window.location.href = window.location.pathname; 
            return;
        }
        wasISeated = amISeated;

        if (isWaitingForServer && amISeated) { isWaitingForServer = false; document.getElementById('sit-modal').classList.add('hidden'); document.getElementById('btn-confirm-sit').innerText = "ç¡®å®šå…¥åº§"; document.getElementById('btn-confirm-sit').disabled = false; }
        if (amISeated) document.getElementById('btn-take-seat').classList.add('hidden'); else if (myName === "" || !isWaitingForServer) document.getElementById('btn-take-seat').classList.remove('hidden'); 

        const layer = document.getElementById("players-layer"); layer.innerHTML = "";
        let isMyTurn = false;
        const visualMap = getSeatMap(currentRoomId);
        let displaySeats = new Array(MAX_SEATS).fill(null);
        
        playersArray.forEach((p, index) => {
            if (!p) return;
            let visualSeatIndex = visualMap[index % 10]; 
            while (displaySeats[visualSeatIndex] !== null) visualSeatIndex = (visualSeatIndex + 1) % 10;
            displaySeats[visualSeatIndex] = { ...p, realIndex: index };
        });

        const isInitialDeal = state.game.status === 'PRE-FLOP' && !playersArray.some(p => p.actedThisRound);

        for (let i = 0; i < MAX_SEATS; i++) {
            const seatClass = SEAT_ORDER[i];
            const p = displaySeats[i]; 
            
            // æ™ºèƒ½é¿è®©ç±»å
            let posClass = ""; let betClass = "";
            if (seatClass.includes("btm")) posClass = "pos-bottom";
            if (seatClass.includes("top")) posClass = "pos-top";
            if (seatClass.includes("lft")) posClass = "pos-left";
            if (seatClass.includes("rgt")) posClass = "pos-right";

            if (p) {
                const isActive = (state.game.status !== "WAITING" && state.game.status !== "SHOWDOWN" && p.realIndex === state.game.turnIndex);
                if (isActive && p.name === myName) isMyTurn = true;
                const isOut = p.isOut === true; 
                const isOffline = p.isOnline === false; 

                let displayAvatar = 'ğŸ˜'; let displayName = p.name;
                if (p.name.includes('|')) { const parts = p.name.split('|'); displayAvatar = parts[0]; displayName = parts[1]; }

                let cardsHtml = "";
                if (p.hand && p.hand.length > 0) {
                    cardsHtml = p.hand.map((c, idx) => {
                        const isHidden = (p.name !== myName && state.game.status !== "SHOWDOWN") || c === "??";
                        const isRed = !isHidden && (c.includes('â™¥') || c.includes('â™¦'));
                        const animDelay = isInitialDeal ? `animation: dealHoleCard 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) backwards; animation-delay: ${(i*0.08) + (idx*0.04)}s;` : '';
                        return `<div class="playing-card ${isHidden?'back':''} ${isRed?'red':''} card-${idx+1}" style="${animDelay}">${isHidden?'':c}</div>`;
                    }).join("");
                }

                // ã€æ ¸å¿ƒï¼šç²¾è‡´å°å·§çš„å†…åµŒçŠ¶æ€æ¡ã€‘
                let badgeHtml = "";
                if (isOffline) badgeHtml = `<div class="status-badge-inner bg-offline">å·²ç¦»çº¿</div>`;
                else if (p.folded && !isOut) badgeHtml = `<div class="status-badge-inner bg-fold">å·²å¼ƒç‰Œ</div>`;
                else if (p.chips === 0 && !isOut && !p.folded && state.game.status !== "WAITING") badgeHtml = `<div class="status-badge-inner bg-allin">ALL-IN</div>`;
                else if (isActive && !p.folded && !isOut) badgeHtml = `<div class="status-badge-inner bg-think">æ€è€ƒä¸­...</div>`;

                let kickHtml = '';
                if (isHost && p.name !== myName) { kickHtml = `<button class="kick-btn" onclick="send({type:'KICK', targetName:'${p.name}'})">è¸¢å‡ºç©å®¶</button>`; }

                layer.innerHTML += `
                    <div class="player-seat ${seatClass} ${posClass}">
                        ${(p.winAmount > 0 && state.game.status === "SHOWDOWN") ? `<div class="win-fly-text">+$${p.winAmount}</div>` : ''}
                        <div class="hole-cards">${p.folded || isOut ? '' : cardsHtml}</div>
                        
                        <div class="player-card ${isActive && !p.folded && !isOut ? 'active' : ''} ${isOut ? 'out-state' : ''}" style="${(p.folded && !isOut) ? 'opacity: 0.6;' : ''}">
                            ${kickHtml}
                            <div class="player-avatar"><span>${displayAvatar}</span></div>
                            
                            <div style="min-height:22px;">${badgeHtml}</div>
                            
                            <div class="player-name">${displayName}</div>
                            <div class="player-chips">$${p.chips}</div>
                        </div>
                        
                        ${isOut ? `<div class="eliminated-x">âŒ</div>` : ''}
                        
                        ${(p.betThisRound > 0 && state.game.status !== "WAITING") ? `<div class="bet-badge">âšª $${p.betThisRound}</div>` : ''}
                    </div>
                `;
            } else { layer.innerHTML += `<div class="player-seat ${seatClass} ${posClass}"><div class="player-card empty-seat"></div></div>`; }
        }

        const actionConsole = document.getElementById("action-console"); const rebuyConsole = document.getElementById("rebuy-console"); const waitingTip = document.getElementById("waiting-tip"); const tableContainer = document.getElementById("table-container"); const btnCallTitle = document.getElementById("btn-call-title"); const btnCallSub = document.getElementById("btn-call-sub"); const actBtns = ["btn-action-fold", "btn-action-call", "btn-action-raise"];
        actionConsole.classList.add("hidden"); rebuyConsole.classList.add("hidden"); waitingTip.classList.add("hidden"); tableContainer.style.transform = "translateY(0) scale(1)";

        if (amISeated) {
            const myData = playersArray.find(p => p && p.name === myName);
            if (!myData) return;
            if (myData.isOut) { rebuyConsole.classList.remove("hidden"); return; }
            if (state.game.status !== "WAITING" && state.game.status !== "SHOWDOWN" && !myData.folded && myData.chips > 0) {
                if (isMyTurn) {
                    actionConsole.classList.remove("hidden"); tableContainer.style.transform = "translateY(-60px) scale(0.95)";
                    const currentBet = Number(state.game.currentBet) || 0; const myBet = Number(myData.betThisRound) || 0; const myChips = Number(myData.chips) || 0; const bigBlind = Number(state.game.bigBlind) || 20;
                    const callAmount = currentBet - myBet;
                    if (callAmount <= 0) { btnCallTitle.innerText = "CHECK"; btnCallSub.innerText = "è¿‡ç‰Œ (å…è´¹)"; document.getElementById("btn-action-call").style.background = "linear-gradient(145deg, #2ecc71, #219653)"; } 
                    else { btnCallTitle.innerText = "CALL"; btnCallSub.innerText = "$" + callAmount; document.getElementById("btn-action-call").style.background = "linear-gradient(145deg, #1976d2, #115293)"; }
                    const minRaiseTo = currentBet + bigBlind; slider.min = minRaiseTo; slider.max = myChips + myBet; 
                    if (parseInt(slider.value) < minRaiseTo || parseInt(slider.value) > slider.max) slider.value = minRaiseTo; updateSliderDisplay();
                    document.getElementById("btn-action-fold").onclick = () => send({type:'ACTION', name: myName, action:'FOLD'});
                    document.getElementById("btn-action-call").onclick = () => send({type:'ACTION', name: myName, action:'CALL'});
                    document.getElementById("btn-action-raise").onclick = () => { const raiseTo = parseInt(slider.value); const extraAmount = raiseTo - currentBet; send({type:'ACTION', name: myName, action:'RAISE', amount: extraAmount}); };
                    actBtns.forEach(id => document.getElementById(id).disabled = false);
                } else {
                    waitingTip.classList.remove("hidden"); const currentActor = playersArray[state.game.turnIndex];
                    if(currentActor) { const actorName = currentActor.name.split('|')[1] || currentActor.name; waitingTip.innerText = `ç­‰å¾… ${actorName} è¡ŒåŠ¨...`; }
                    actBtns.forEach(id => document.getElementById(id).disabled = true);
                }
            }
        }
    }
</script>

</body>
</html>
