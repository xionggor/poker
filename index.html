<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CB POKER - ç§äººå±€å¤§å…</title>
    <style>
        :root { --poker-green: #1a4a32; --gold: #ffd700; --bg: #121212; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .card { background: #222; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 350px; text-align: center; border: 1px solid #333; }
        h1 { color: var(--gold); margin-bottom: 30px; letter-spacing: 2px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #333; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 15px; margin-top: 20px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-create { background: var(--gold); color: black; }
        .btn-join { background: #3498db; color: white; }
        .hidden { display: none; }
        #player-list { margin-top: 20px; text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; }
        .player-item { padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .share-box { background: #333; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 12px; color: var(--gold); word-break: break-all; }
    </style>
</head>
<body>

    <div id="lobby-view" class="card">
        <h1>CB POKER</h1>
        <p id="lobby-msg">åˆ›å»ºä½ çš„ç§äººå¾·å·æˆ¿é—´</p>
        <button id="create-btn" class="btn-create" onclick="createRoom()">åˆ›å»ºæ–°æˆ¿é—´</button>
    </div>

    <div id="join-view" class="card hidden">
        <h1>å‡†å¤‡å…¥åº§</h1>
        <input type="text" id="name-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°...">
        <button class="btn-join" onclick="joinRoom()">å…¥åº§ç­‰å¾…</button>
    </div>

    <div id="game-view" class="card hidden">
        <h2 id="room-status">ç­‰å¾…ä¸­...</h2>
        <div id="player-list"></div>
        <div class="share-box" id="share-link"></div>
        <button id="start-btn" class="btn-create hidden" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    </div>

<script>
    // ä½ çš„ Cloudflare åç«¯åœ°å€
    const BACKEND_URL = "https://poker-server.zxc717209554.workers.dev";
    
    let ws = null;
    let roomId = new URLSearchParams(window.location.search).get("room");
    let isOwner = false;

    // åˆå§‹åŒ–æ£€æŸ¥
    window.onload = () => {
        if (roomId) {
            document.getElementById("lobby-msg").innerText = "å·²å‘ç°æˆ¿é—´: " + roomId.substring(0,8);
            showView("join-view");
        }
    };

    // 1. åˆ›å»ºæˆ¿é—´
    async function createRoom() {
        try {
            const res = await fetch(`${BACKEND_URL}/create-room`, { method: "POST" });
            const data = await res.json();
            roomId = data.roomId;
            isOwner = true;
            window.history.pushState({}, "", `?room=${roomId}`);
            showView("join-view");
        } catch (e) {
            alert("æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ Worker æ˜¯å¦æ­£å¸¸è¿è¡Œ");
        }
    }

    // 2. åŠ å…¥æˆ¿é—´ (WebSocket)
    function joinRoom() {
        const name = document.getElementById("name-input").value.trim();
        if (!name) return alert("è¯·è¾“å…¥åå­—");

        const wsUrl = BACKEND_URL.replace("https://", "wss://") + `?roomId=${roomId}`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            ws.send(JSON.stringify({ type: "JOIN", name: name }));
            showView("game-view");
            document.getElementById("share-link").innerText = "é‚€è¯·å¥½å‹: " + window.location.href;
            if (isOwner) document.getElementById("start-btn").classList.remove("hidden");
        };

        ws.onmessage = (event) => {
            const state = JSON.parse(event.data);
            renderPlayers(state.players);
            if (state.status === "PLAYING") {
                document.getElementById("room-status").innerText = "ğŸƒ æ¸¸æˆå·²å¼€å§‹ï¼";
            }
        };
    }

    // 3. å¼€å§‹æ¸¸æˆ
    function startGame() {
        if (ws) ws.send(JSON.stringify({ type: "START_GAME" }));
    }

    function showView(viewId) {
        ["lobby-view", "join-view", "game-view"].forEach(id => {
            document.getElementById(id).classList.add("hidden");
        });
        document.getElementById(viewId).classList.remove("hidden");
    }

    function renderPlayers(players) {
        const list = document.getElementById("player-list");
        list.innerHTML = "<strong>å·²å…¥åº§:</strong>" + players.map(p => `
            <div class="player-item">
                <span>${p.name}</span>
                <span style="color:#ffd700">$${p.chips}</span>
            </div>
        `).join("");
    }
</script>
</body>
</html>
